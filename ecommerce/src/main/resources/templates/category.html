<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" class="no-js">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" th:href="@{/img/icon.png}" />
    <title>Waxen</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- intl-tel-input CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/css/intlTelInput.css"
    />

    <!-- ============================================= -->
    <link rel="stylesheet" th:href="@{/css/linearicons.css}" />
    <link rel="stylesheet" th:href="@{/css/font-awesome.min.css}" />
    <link rel="stylesheet" th:href="@{/css/themify-icons.css}" />
    <link rel="stylesheet" th:href="@{/css/bootstrap.css}" />
    <link rel="stylesheet" th:href="@{/css/owl.carousel.css}" />
    <link rel="stylesheet" th:href="@{/css/nice-select.css}" />
    <link rel="stylesheet" th:href="@{/css/nouislider.min.css}" />
    <link rel="stylesheet" th:href="@{/css/ion.rangeSlider.css}" />
    <link rel="stylesheet" th:href="@{/css/ion.rangeSlider.skinFlat.css}" />
    <link rel="stylesheet" th:href="@{/css/magnific-popup.css}" />
    <link rel="stylesheet" th:href="@{/css/main.css}" />

    <style>
      .price-inputs {
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: center;
        margin-top: 10px;
      }

      .price-inputs input[type="number"] {
        width: 100%;
        padding: 8px 10px;
        font-size: 14px;
        border: 1px solid #ddd;
        border-radius: 4px;
        outline: none;
        transition: border-color 0.3s;
      }

      .price-inputs input[type="number"]:focus {
        border-color: #ffba00; /* Change color as desired */
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.2);
      }

      #category-list li a.active {
        color: #ffba00;
      }

      /* Style for suggestions dropdown */
      #suggestions {
        display: none; /* Initially hidden */
        position: absolute;
        top: 100%; /* Aligns directly below the input box */
        left: 0;
        width: 100%; /* Matches input width */
        background-color: #fff;
        border: 1px solid #ddd;
        border-top: none; /* Avoid double border with input */
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        list-style: none;
        padding: 0;
        margin: 0;
        z-index: 1000;
        max-height: 200px; /* Limits height */
        overflow-y: auto; /* Adds scroll if suggestions exceed max height */
      }

      #suggestions li {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
      }

      #suggestions li:last-child {
        border-bottom: none; /* Removes border from last item */
      }

      #suggestions li:hover {
        background-color: #f5f5f5;
      }

      .navbar-brand img {
        max-width: 60%;
        /* Prevents the image from overflowing its container */
        height: auto;
      }

      .navbar-brand {
        max-width: 30%;
        /* Prevents the image from overflowing its container */
        height: auto;
      }
      /* Base styles for product images */
      .single-product img {
        width: 100%; /* Full width of the card */
        height: 250px; /* Default height for medium to large screens */
        object-fit: cover; /* Crop image to fill dimensions */
      }

      /* Adjust image height for smaller screens */
      @media (max-width: 768px) {
        .single-product img {
          height: 200px; /* Reduce height on tablets */
        }
      }

      @media (max-width: 576px) {
        .single-product img {
          height: 150px; /* Further reduce height on mobile devices */
        }
      }
      .waxen {
        padding-top: 230px;
      }
      .waxen6 {
        padding-top: 20px;
      }
    </style>
    <!-- jQuery CDN -->
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
  </head>

  <body id="category">
    <!-- Start Header Area -->
    <header class="header_area sticky-header">
      <div class="main_menu">
        <nav class="navbar navbar-expand-lg navbar-light main_box">
          <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <a class="navbar-brand logo_h" href="/home"
              ><img src="/img/waxen.jpg" alt=""
            /></a>
            <button
              class="navbar-toggler"
              type="button"
              data-toggle="collapse"
              data-target="#navbarSupportedContent"
              aria-controls="navbarSupportedContent"
              aria-expanded="false"
              aria-label="Toggle navigation"
            >
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div
              class="collapse navbar-collapse offset"
              id="navbarSupportedContent"
            >
              <ul class="nav navbar-nav menu_nav ml-auto">
                <li class="nav-item">
                  <a class="nav-link" href="/home">Home</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="/shop">Shop</a>
                </li>
                <li class="nav-item submenu dropdown">
                  <a
                    href="#"
                    class="nav-link dropdown-toggle"
                    data-toggle="dropdown"
                    role="button"
                    aria-haspopup="true"
                    aria-expanded="false"
                    >Account</a
                  >
                  <ul class="dropdown-menu" id="dropdown-menu-auth"></ul>
                </li>
              </ul>
              <ul class="nav navbar-nav navbar-right">
                <li class="nav-item">
                  <a href="/cart" class="cart"
                    ><span class="ti-shopping-cart"></span
                  ></a>
                </li>
                <li class="nav-item">
                  <button class="search">
                    <span class="lnr lnr-magnifier" id="search"></span>
                  </button>
                </li>
              </ul>
            </div>
          </div>
        </nav>
      </div>
      <div class="search_input" id="search_input_box">
        <div class="container">
          <form class="d-flex justify-content-between" onsubmit="">
            <input
              type="text"
              class="form-control"
              id="search_input"
              placeholder="Search Here"
              oninput="showSuggestions(this.value)"
            />
            <button type="submit" class="btn"></button>
            <span
              class="lnr lnr-cross"
              id="close_search"
              title="Close Search"
            ></span>
          </form>
          <!-- Suggestions List -->
          <ul id="suggestions"></ul>
        </div>
      </div>
    </header>
    <!-- End Header Area -->
    <div class="container waxen">
      <div class="row">
        <div class="col-xl-3 col-lg-4 col-md-5">
          <div class="sidebar-categories">
            <div class="head">Browse Categories</div>
            <ul id="category-list" class="main-categories">
              <!-- Categories will be populated via AJAX -->
            </ul>
          </div>
          <div class="sidebar-filter mt-50 waxen6">
            <div class="top-filter-head">Product Filters</div>

            <div class="common-filter">
              <div class="head">Brands</div>
              <div id="brand-checkboxes">
                <!-- Brand checkboxes populated via AJAX -->
              </div>
            </div>

            <div class="common-filter">
              <div class="head">Material</div>
              <div id="material-checkboxes">
                <!-- Material checkboxes populated via AJAX -->
              </div>
            </div>

            <div class="common-filter">
              <div class="head">Price</div>
              <div class="price-inputs">
                <input
                  type="number"
                  id="min-price"
                  placeholder="Min Price"
                  min="0"
                  step="1"
                />

                <input
                  type="number"
                  id="max-price"
                  placeholder="Max Price"
                  min="0"
                  step="1"
                />
              </div>
            </div>
          </div>
        </div>
        <div class="col-xl-9 col-lg-8 col-md-7">
          <!-- Start Filter Bar -->
          <div class="filter-bar d-flex flex-wrap align-items-center">
            <div class="pagination" id="pagination-controls">
              <a href="#" class="prev-arrow" id="prev-page"
                ><i class="fa fa-long-arrow-left" aria-hidden="true"></i
              ></a>
              <!-- Pagination buttons will be populated here via AJAX -->
              <div id="pagination-numbers" class="pagination-numbers"></div>
              <a href="#" class="next-arrow" id="next-page"
                ><i class="fa fa-long-arrow-right" aria-hidden="true"></i
              ></a>
            </div>
          </div>
          <!-- End Filter Bar -->
          <!-- Start Best Seller -->
          <section class="lattest-product-area pb-40 category-list">
            <div class="row" id="product-list">
              <!-- Products will be populated here via AJAX -->
            </div>
          </section>
          <!-- End Best Seller -->
        </div>
      </div>
    </div>

    <input type="hidden" id="queryValue" th:value="${query}" />
    <input type="hidden" id="searchValue" th:value="${search}" />

    <!-- start footer Area -->
    <footer class="footer-area section_gap">
        <div class="container">
            <div class="row">
				<div class="single-footer-widget" style="text-align: justify;">
					<h6>About Us</h6>
					<p>
						Welcome to Waxen, where luxury and style meet in every timepiece. We offer a curated selection of world-renowned brands like G-Shock, CASIO, Fossil, ALBA, CITIZEN, TOMMY HILFIGER, NAVIFORCE, and TIMEX.
						From SPORTY watches for adventurers to CLASSIC and CASUAL designs for everyday elegance, our diverse collections suit every style. Discover SMART technology, PREMIUM craftsmanship, and timeless Analog watches, each embodying quality and individuality.	
						At Waxen, we’re passionate about excellence—explore our collections and find a watch that’s uniquely yours.
					</p>
				</div>
                <div class="col-lg-4  col-md-6 col-sm-6">
                    <div class="single-footer-widget">
                        <h6>Newsletter</h6>
                        <p>Stay update with our latest</p>
                        <div class="" id="mc_embed_signup">

                    <!-- <div class="col-lg-4 col-md-4">
												<button class="bb-btn btn"><span class="lnr lnr-arrow-right"></span></button>
											</div>  -->
                  </div>
                  <div class="info"></div>
                </form>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-6 col-sm-6">
            <div class="single-footer-widget mail-chimp">
              <h6 class="mb-20">Instragram Feed</h6>
              <ul class="instafeed d-flex flex-wrap">
                <li><img src="img/i1.jpg" alt="" /></li>
                <li><img src="img/i2.jpg" alt="" /></li>
                <li><img src="img/i3.jpg" alt="" /></li>
                <li><img src="img/i4.jpg" alt="" /></li>
                <li><img src="img/i5.jpg" alt="" /></li>
                <li><img src="img/i6.jpg" alt="" /></li>
                <li><img src="img/i7.jpg" alt="" /></li>
                <li><img src="img/i8.jpg" alt="" /></li>
              </ul>
            </div>
          </div>
          <div class="col-lg-2 col-md-6 col-sm-6">
            <div class="single-footer-widget">
              <h6>Follow Us</h6>
              <p>Let us be social</p>
              <div class="footer-social d-flex align-items-center">
                <a href="#"><i class="fa fa-facebook"></i></a>
                <a href="#"><i class="fa fa-twitter"></i></a>
                <a href="#"><i class="fa fa-dribbble"></i></a>
                <a href="#"><i class="fa fa-behance"></i></a>
              </div>
            </div>
          </div>
        </div>
        <div
          class="footer-bottom d-flex justify-content-center align-items-center flex-wrap"
        >
          <p class="footer-text m-0">
            <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
            Copyright &copy;
            <script>
              document.write(new Date().getFullYear());
            </script>
            All rights reserved | This template is made with
            <i class="fa fa-heart-o" aria-hidden="true"></i> by
            <a href="https://colorlib.com" target="_blank">Colorlib</a>
            <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
          </p>
        </div>
      </div>
    </footer>
    <!-- End footer Area -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/intlTelInput.min.js"></script>

    <script th:src="@{/js/vendor/jquery-2.2.4.min.js}"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"
      integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4"
      crossorigin="anonymous"
    ></script>

    <!-- End footer Area -->
    <script th:src="@{/js/vendor/bootstrap.min.js}"></script>
    <script th:src="@{/js/jquery.ajaxchimp.min.js}"></script>
    <script th:src="@{/js/jquery.nice-select.min.js}"></script>
    <script th:src="@{/js/jquery.sticky.js}"></script>
    <script th:src="@{/js/nouislider.min.js}"></script>
    <script th:src="@{/js/jquery.magnific-popup.min.js}"></script>
    <script th:src="@{/js/owl.carousel.min.js}"></script>
    <script th:src="@{/js/main.js}"></script>
    <!-- Other scripts that depend on jQuery should go after this -->

    <script>
      let currentPage = 0;
      let totalPages = 0;
      let selectedCategory = null;

      $(document).ready(function () {
        // Load initial data
        loadCategories();
        loadBrands();
        loadMaterials();
        fetchProducts();

        // Event listeners
        $("#category-list").on("click", "a", handleCategoryClick);
        $("#pagination-controls").on("click", "a", handlePaginationClick);
        $(document).on(
          "change",
          'input[name="brands"], input[name="materials"], #min-price, #max-price',
          fetchFilteredProducts
        );
        $(document).on("click", ".add-to-cart", function (e) {
          e.preventDefault(); // Prevent default link behavior

          // Get the product ID from the data attribute
          const productId = $(this).data("product-id");
          const quantity = 1; // Default quantity to 1

          // AJAX GET request to add the product to the cart
          $.ajax({
            url: "/cart/add", // The endpoint for adding to the cart
            type: "GET",
            data: {
              productId: productId,
              quantity: quantity,
            },
            success: function (response) {
              // Success: handle the response (e.g., update cart UI, show notification)
              alert("Product added to cart successfully!");
              // Optionally update the cart count or other UI elements
            },
            error: function (xhr, status, error) {
              // Error: handle the error (e.g., show error message)
              console.log(status);
              console.log(error);
              alert("Failed to add product to cart. Please try again.");
            },
          });
        });

        const query = document.getElementById("queryValue").value;
        const search = document.getElementById("searchValue").value === "true"; // Convert to boolean

        if (search && query) {
          console.log("Query:", query);
          selectSuggestion(query); // Call your function with the query value
        }
      });

      function loadCategories() {
        $.get("/category/categories", function (data) {
          const categoryList = $("#category-list").empty();
          let itemsCount = 0;

          data.forEach((category) => {
            itemsCount += category.itemsCount;
            categoryList.append(createCategoryItem(category));
          });
          categoryList.append(`
			<li class="main-nav-list child">
				<a href="#" data-id="null" class="category-item active">
					Browse All <span class="number">${itemsCount}</span>
				</a>
			</li>
		`);
        }).fail((error) => console.error("Error fetching categories:", error));
      }

      function createCategoryItem(category) {
        return `
			<li class="main-nav-list child">
				<a href="#" data-id="${category.id}" class="category-item">
					${category.name} <span class="number">${category.itemsCount}</span>
				</a>
			</li>
		`;
      }

      function handleCategoryClick(event) {
        event.preventDefault();
        const categoryLink = $(this);

        $("#category-list a").removeClass("active");
        categoryLink.addClass("active");
        selectedCategory =
          categoryLink.data("id") === "null" ? null : categoryLink.data("id");

        fetchFilteredProducts();
      }

      function fetchProducts() {
        $.get(`/products/filter?page=${currentPage}`, function (data) {
          totalPages = data.totalPages;
          displayProducts(data.content);
          updatePagination(totalPages, data.pageable.pageNumber);
        }).fail((error) => console.error("Error fetching products:", error));
      }

      function displayProducts(products) {
        const productList = $("#product-list").empty();
        products.forEach((product) =>
          productList.append(createProductItem(product))
        );
      }

      function createProductItem(product) {
        return `
			<div class="col-lg-4 col-md-6">
				<div class="single-product">
					<img class="img-fluid" src="${product.image}" alt="${product.name}">
					<div class="product-details">
						<h6>${product.name}</h6>
						<div class="price">
							<h6>$${product.price.toFixed(2)}</h6>
							<h6 class="l-through">$${(product.price * 1.4).toFixed(2)}</h6>
						</div>
						<div class="prd-bottom">
							<a href="#" class="social-info add-to-cart" data-product-id="${
                product.id
              }"><span class="ti-shopping-cart"></span><p class="hover-text">Add to bag</p></a>
							<a href="/details/${
                product.id
              }" class="social-info"><span class="lnr lnr-move"></span><p class="hover-text">View more</p></a>
						</div>
					</div>
				</div>
			</div>
		`;
      }

      function updatePagination(totalPages, currentPage) {
        const paginationControls = $("#pagination-controls").empty();
        if (currentPage > 0) {
          paginationControls.append(
            createPaginationLink(
              currentPage - 1,
              "prev-arrow",
              '<i class="fa fa-long-arrow-left"></i>'
            )
          );
        }

        for (let i = 0; i < totalPages; i++) {
          const activeClass = i === currentPage ? "active" : "";
          paginationControls.append(
            createPaginationLink(i, activeClass, i + 1)
          );
        }

        if (currentPage < totalPages - 1) {
          paginationControls.append(
            createPaginationLink(
              currentPage + 1,
              "next-arrow",
              '<i class="fa fa-long-arrow-right"></i>'
            )
          );
        }
      }

      function createPaginationLink(page, className, content) {
        return `<a href="#" class="${className}" data-page="${page}">${content}</a>`;
      }

      function handlePaginationClick(event) {
        event.preventDefault();
        currentPage = $(this).data("page");
        console.log(currentPage);
        fetchFilteredProducts();
      }

      function fetchFilteredProducts() {
        // if(totalPages<currentPage)currentPage=totalPages
        const data = {
          brands: getSelectedValues("brands"),
          materials: getSelectedValues("materials"),
          minPrice: $("#min-price").val(),
          maxPrice: $("#max-price").val(),
          categoryId: selectedCategory,
          page: currentPage,
          size: 8,
        };

        console.log("filterd" + JSON.stringify(data));
        $.get("/products/filter", data, function (response) {
          totalPages = response.totalPages;
          displayProducts(response.content);
          updatePagination(totalPages, response.pageable.pageNumber);
        }).fail((error) =>
          console.error("Error fetching filtered products:", error)
        );
      }

      function getSelectedValues(name) {
        return $(`input[name="${name}"]:checked`)
          .map((_, element) => $(element).val())
          .get();
      }

      function loadBrands() {
        $.get("/products/brands", function (data) {
          const brandContainer = $("#brand-checkboxes").empty();
          data.forEach((brand) =>
            brandContainer.append(createCheckbox("brands", brand))
          );
        }).fail((error) => console.error("Error fetching brands:", error));
      }

      function loadMaterials() {
        $.get("/products/materials", function (data) {
          const materialContainer = $("#material-checkboxes").empty();
          data.forEach((material) =>
            materialContainer.append(createCheckbox("materials", material))
          );
        }).fail((error) => console.error("Error fetching materials:", error));
      }

      function createCheckbox(name, value) {
        return `<label><input type="checkbox" name="${name}" value="${value}"> ${value}</label><br>`;
      }

      // Function to fetch and display suggestions as user types
      function showSuggestions(query) {
        const suggestionList = $("#suggestions").empty();
        if (query.length < 2) {
          $("#suggestions").hide();
          return;
        }

        $.ajax({
          url: "/products/search", // Endpoint for suggestions
          type: "GET",
          data: { name: query },
          success: function (suggestions) {
            console.log(suggestions);
            if (suggestions.length === 0) {
              suggestionList.hide();
              return;
            }
            suggestions.forEach((suggestion) => {
              suggestionList.append(
                `<li onclick="selectSuggestion('${suggestion.name}')">${suggestion.name}</li>`
              );
            });
            suggestionList.show();
          },
        });
      }
      // Function to set suggestion in search input
      function selectSuggestion(suggestion) {
        console.log(suggestion);
        $("#search_input").val(suggestion);
        $("#suggestions").hide();
        performSearch();
      }
      function performSearch() {
        const query = $("#search_input").val().trim();
        if (query === "") return false;

        $.ajax({
          url: "/products/result", // Endpoint for full search
          type: "GET",
          data: { name: query },
          success: function (products) {
            totalPages = products.totalPages;
            displayProducts(products.content);
            updatePagination(totalPages, products.pageable.pageNumber);
            $("#suggestions").hide();
          },
          error: function (err) {
            alert("error");
          },
        });

        return false; // Prevents form submission
      }

      /*========================= Header AJAX ==================== */
      $(document).ready(function () {
        checkAuthStatus();
      });

      function checkAuthStatus() {
        $.ajax({
          url: "/auth/status",
          type: "GET",
          success: function (response) {
            if (response.authenticated) {
              // User is authenticated
              $("#dropdown-menu-auth").html(`
                        <li class="nav-item"><a class="nav-link" href="/user/account">My-Account</a></li>
                        <li class="nav-item"><a class="nav-link" href="/logout">Logout</a></li>
                    `);
            } else {
              // User is not authenticated
              $("#dropdown-menu-auth").html(`
                        <li class="nav-item"><a class="nav-link" href="/auth/login">Login</a></li>
                        <li class="nav-item"><a class="nav-link" href="/auth/registeration">Register</a></li>
                    `);
            }
          },
          error: function (error) {
            console.error("Error checking authentication status:", error);
          },
        });
      }
    </script>
  </body>
</html>
