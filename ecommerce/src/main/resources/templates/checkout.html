<!DOCTYPE html>
<html class="no-js" lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <!--    <link-->
    <!--            rel="stylesheet"-->
    <!--            type="text/css"-->
    <!--            href="https://www.paypalobjects.com/webstatic/en_US/developer/docs/css/cardfields.css"-->
    <!--    />-->

    <link rel="shortcut icon" th:href="@{/img/icon.png}"/>
    <title>Waxen</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- intl-tel-input CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/css/intlTelInput.css" rel="stylesheet">

    <!--
		CSS
		============================================= -->
    <link rel="stylesheet" th:href="@{/css/linearicons.css}">
    <link rel="stylesheet" th:href="@{/css/font-awesome.min.css}">
    <link rel="stylesheet" th:href="@{/css/themify-icons.css}">
    <link rel="stylesheet" th:href="@{/css/bootstrap.css}">
    <link rel="stylesheet" th:href="@{/css/owl.carousel.css}">
    <link rel="stylesheet" th:href="@{/css/nice-select.css}">
    <link rel="stylesheet" th:href="@{/css/nouislider.min.css}">
    <link rel="stylesheet" th:href="@{/css/ion.rangeSlider.css}">
    <link rel="stylesheet" th:href="@{/css/ion.rangeSlider.skinFlat.css}">
    <link rel="stylesheet" th:href="@{/css/magnific-popup.css}">
    <link rel="stylesheet" th:href="@{/css/main.css}">


    <style>
        .navbar-brand img {
            max-width: 60%;
            /* Prevents the image from overflowing its container */
            height: auto;
        }

        .navbar-brand {
            max-width: 30%;
            /* Prevents the image from overflowing its container */
            height: auto;
        }

        /* Style for suggestions dropdown */
        #suggestions {
            display: none; /* Initially hidden */
            position: absolute;
            top: 100%; /* Aligns directly below the input box */
            left: 0;
            width: 100%; /* Matches input width */
            background-color: #fff;
            border: 1px solid #ddd;
            border-top: none; /* Avoid double border with input */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            list-style: none;
            padding: 0;
            margin: 0;
            z-index: 1000;
            max-height: 200px; /* Limits height */
            overflow-y: auto; /* Adds scroll if suggestions exceed max height */
        }

        #suggestions li {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        #suggestions li:last-child {
            border-bottom: none; /* Removes border from last item */
        }

        #suggestions li:hover {
            background-color: #f5f5f5;
        }

        .card-option {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            transition: background-color 0.3s ease;
        }

        .card-option:hover {
            background-color: #f7f7f7;
        }

        .card-option input[type="radio"] {
            margin-right: 10px;
        }

        .card-option label {
            margin: 0;
            cursor: pointer;
            font-weight: bold;
        }

        .card-option label span {
            color: #007bff;
        }

        .card-option label .card-number {
            font-weight: normal;
        }

        .card-option label .exp-date {
            font-size: 0.9em;
            color: #888;
        }


        .card-option {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .card-option:hover {
            transform: scale(1.02);
        }

        .card-option input[type="radio"] {
            margin-right: 15px;
        }

        .card-option label {
            width: 100%;
        }

        .card-option div {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-option label span {
            font-size: 1.1em;
            font-weight: bold;
            color: #007bff;
        }

        .card-option label .card-number {
            color: #555;
        }

        .card-option label .exp-date {
            font-size: 0.9em;
            color: #888;
        }

        .waxen5 {
            padding-top: 200px;
        }

        /* Style the PayPal button container */
        .paypal-button-container {
            margin-top: 20px;
            margin-bottom: 20px;
            text-align: center; /* Center the button */
            width: 100%; /* Full width, adjust as needed */
        }

        /* Optional: To fix layout issues if the buttons get squeezed */
        .paypal-button-container iframe {
            max-width: 100%;
            height: auto;
        }

        #payment-section .paypal-button-container iframe {
            border-radius: 5px;
            border: 1px solid #ccc;
            margin-top: 10px;
        }

        .cust-style {
            display: block;
            width: 100%;
            font-size: large;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-top: 2px solid #000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }


    </style>
    <script crossorigin="anonymous"
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

</head>

<body>

<!-- Start Header Area -->
<header class="header_area sticky-header">
    <div class="main_menu">
        <nav class="navbar navbar-expand-lg navbar-light main_box">
            <div class="container">
                <!-- Brand and toggle get grouped for better mobile display -->
                <a class="navbar-brand logo_h" href="/home"><img alt="" src="/img/waxen.jpg"></a>
                <button aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"
                        class="navbar-toggler" data-target="#navbarSupportedContent"
                        data-toggle="collapse" type="button">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <!-- Collect the nav links, forms, and other content for toggling -->
                <div class="collapse navbar-collapse offset" id="navbarSupportedContent">
                    <ul class="nav navbar-nav menu_nav ml-auto">
                        <li class="nav-item"><a class="nav-link" href="/home">Home</a></li>
                        <li class="nav-item"><a class="nav-link" href="/shop">Shop</a></li>
                        <li class="nav-item submenu dropdown">
                            <a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown"
                               href="#" role="button">Account</a>
                            <ul class="dropdown-menu" id="dropdown-menu-auth"></ul>
                        </li>
                    </ul>
                    <ul class="nav navbar-nav navbar-right">
                        <li class="nav-item"><a class="cart" href="/cart"><span class="ti-shopping-cart"></span></a>
                        </li>
                        <li class="nav-item">
                            <button class="search"><span class="lnr lnr-magnifier" id="search"></span></button>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </div>
    <div class="search_input" id="search_input_box">
        <div class="container">
            <form class="d-flex justify-content-between" onsubmit="">
                <input class="form-control" id="search_input" oninput="showSuggestions(this.value)" placeholder="Search Here"
                       type="text">
                <button class="btn" type="submit"></button>
                <span class="lnr lnr-cross" id="close_search" title="Close Search"></span>
            </form>
            <!-- Suggestions List -->
            <ul id="suggestions"></ul>
        </div>

    </div>
</header>
<!-- End Header Area -->

<!--================Checkout Area =================-->
<div class="action-message" id="action-message" style="display: none;"></div>

<section class="checkout_area section_gap  waxen5">
    <div class="container">
        <div class="billing_details">
            <div class="row">
                <!-- Left Column for Address, Order details and Payment -->
                <div class="col-lg-8">
                    <!-- Address Section -->
                    <h4>Shipping Address</h4>
                    <div id="address-section">
                        <!-- Dynamically populated by JavaScript -->
                    </div>

                    <br>
                    <h4>Your Order</h4>
                    <div id="order-section">
                        <!-- Dynamically populated by JavaScript -->
                        <!-- fetch order details -->
                    </div>


                    <!-- Payment Section -->
                    <br>
                    <h4>Payment</h4>
                    <div id="payment-section">
                        <h6>Select Payment Method:</h6>

                        <!-- COD Option -->
                        <input id="cod" name="payment" type="radio" value="COD">
                        <label for="cod">Cash on Delivery</label><br>

                        <!-- Card Option -->
                        <input class="payment-method" id="card" name="payment" type="radio" value="Card">
                        <label for="card">Credit/Debit Card</label><br>

                        <div class="row">
                            <div class="col-lg-6 col-12">
                                <div class="paypal-button-container" id="paypal-button-container"></div>
                                <p id="result-message"></p>
                            </div>
                        </div>


                        <!-- Saved Cards Section (Initially hidden) -->
                        <div id="saved-cards-section" style="display: none;">
                            <p>Your Saved Cards:</p>
                            <!-- Dynamically populated saved cards will appear here -->
                        </div>

                        <!-- Add New Card Form (Initially hidden) -->
                        <br>
                        <div id="new-card-section" style="display: none;">
                            <h4>Add New Card</h4>
                            <form id="new-card-form">
                                <div class="form-group">
                                    <label for="card-number">Card Number</label>
                                    <input class="form-control" id="card-number" maxlength="16"
                                           pattern="\d{16}" placeholder="1234 5678 9101 1121"
                                           required title="Card number must be 16 digits" type="text">
                                    <span class="error-message" id="card-number-error"
                                          style="color: red; display: none;">Invalid card number</span>
                                </div>
                                <div class="form-group">
                                    <label for="card-holder">Card Holder Name</label>
                                    <input class="form-control" id="card-holder" placeholder="John Doe" required
                                           type="text">
                                    <span class="error-message" id="card-holder-error"
                                          style="color: red; display: none;">Cardholder name is required</span>
                                </div>
                                <div class="form-group">
                                    <label for="exp-month">Expiration Month</label>
                                    <input class="form-control" id="exp-month" max="12" min="1" pattern="\d{1}/\d{2}"
                                           placeholder="MM" required title="Expiration month must be between 01 and 12"
                                           type="number">
                                    <span class="error-message" id="exp-month-error" style="color: red; display: none;">Invalid expiration month</span>
                                </div>
                                <div class="form-group">
                                    <label for="exp-year">Expiration Year</label>
                                    <input class="form-control" id="exp-year" min="2024" pattern="\d{4}" placeholder="YYYY"
                                           required title="Expiration year must be 2024 or later"
                                           type="number">
                                    <span class="error-message" id="exp-year-error" style="color: red; display: none;">Invalid expiration year</span>
                                </div>
                                <div class="form-group">
                                    <label for="cvv">CVV</label>
                                    <input class="form-control" id="cvv" maxlength="3" pattern="\d{3}" placeholder="123"
                                           required
                                           title="CVV must be exactly 3 digits" type="text">
                                    <span class="error-message" id="cvv-error" style="color: red; display: none;">Invalid CVV</span>
                                </div>


                                <!-- Save Card Button -->
                                <button class="primary-btn" id="save-card-btn" type="button">Save Card</button>
                            </form>
                            <br>
                        </div>
                    </div>
                </div>

                <!-- Right Column for Order Summary -->
                <div class="col-lg-4">
                    <div class="order_box">
                        <h2>Order Summary</h2>
                        <ul class="list" id="order-items">
                            <!-- Dynamically populated order items -->
                        </ul>

                        <ul class="list list_2">
                            <div id="subtotal"></div>
                            <div id="shipping-cost"></div>
                            <div id="total-price"></div>
                        </ul>

                        <div style="width: 100%; max-width: 500px;">  <!-- Ensure the container has enough width -->
                            <ul style="list-style-type: none; padding: 0; margin: 0;">
                                <!-- Add UL for better structure -->
                                <li style="display: flex; align-items: center; margin-top: 10px; margin-bottom: 10px; width: 100%;">
                                    <input id="coupon-code" placeholder="Enter coupon code" style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-right: 10px; margin-top: 17px; min-width: 200px; height: 40px; box-sizing: border-box;"
                                           type="text"/>
                                    <button id="apply-coupon"
                                            style="padding: 0 15px; margin-top: auto; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; height: 40px; line-height: 40px;">
                                        Apply
                                    </button>
                                </li>
                            </ul>
                        </div>


                        <div class="message" id="message"></div>
                        <br>
                        <button class="primary-btn cust-style" id="place-order-btn"
                                style="line-height: 50px; border-radius: 50px;">
                            <span id="button-text">Place Order</span>
                            <span id="spinner" class="spinner" style="display: none;"></span>
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>
</section>

<!--================End Checkout Area =================-->

<!-- start footer Area -->
<footer class="footer-area section_gap">
    <div class="container">
        <div class="row">
            <div class="col-lg-3  col-md-6 col-sm-6">
                <div class="single-footer-widget">
                    <h6>About Us</h6>
                    <p>
                        Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt
                        ut labore dolore
                        magna aliqua.
                    </p>
                </div>
            </div>
            <div class="col-lg-4  col-md-6 col-sm-6">
                <div class="single-footer-widget">
                    <h6>Newsletter</h6>
                    <p>Stay update with our latest</p>
                    <div class="" id="mc_embed_signup">

                        <form action="https://spondonit.us12.list-manage.com/subscribe/post?u=1462626880ade1ac87bd9c93a&amp;id=92a4423d01" class="form-inline"
                              method="get"
                              novalidate="true" target="_blank">

                            <div class="d-flex flex-row">

                                <input class="form-control" name="EMAIL" onblur="this.placeholder = 'Enter Email '"
                                       onfocus="this.placeholder = ''" placeholder="Enter Email"
                                       required="" type="email">


                                <button class="click-btn btn btn-default"><i aria-hidden="true"
                                                                             class="fa fa-long-arrow-right"></i></button>
                                <div style="position: absolute; left: -5000px;">
                                    <input name="b_36c4fd991d266f23781ded980_aefe40901a" tabindex="-1" type="text"
                                           value="">
                                </div>

                                <!-- <div class="col-lg-4 col-md-4">
                                            <button class="bb-btn btn"><span class="lnr lnr-arrow-right"></span></button>
                                        </div>  -->
                            </div>
                            <div class="info"></div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-lg-3  col-md-6 col-sm-6">
                <div class="single-footer-widget mail-chimp">
                    <h6 class="mb-20">Instragram Feed</h6>
                    <ul class="instafeed d-flex flex-wrap">
                        <li><img alt="" src="img/i1.jpg"></li>
                        <li><img alt="" src="img/i2.jpg"></li>
                        <li><img alt="" src="img/i3.jpg"></li>
                        <li><img alt="" src="img/i4.jpg"></li>
                        <li><img alt="" src="img/i5.jpg"></li>
                        <li><img alt="" src="img/i6.jpg"></li>
                        <li><img alt="" src="img/i7.jpg"></li>
                        <li><img alt="" src="img/i8.jpg"></li>
                    </ul>
                </div>
            </div>
            <div class="col-lg-2 col-md-6 col-sm-6">
                <div class="single-footer-widget">
                    <h6>Follow Us</h6>
                    <p>Let us be social</p>
                    <div class="footer-social d-flex align-items-center">
                        <a href="#"><i class="fa fa-facebook"></i></a>
                        <a href="#"><i class="fa fa-twitter"></i></a>
                        <a href="#"><i class="fa fa-dribbble"></i></a>
                        <a href="#"><i class="fa fa-behance"></i></a>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-bottom d-flex justify-content-center align-items-center flex-wrap">
            <p class="footer-text m-0">
                <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
                Copyright &copy;
                <script>document.write(new Date().getFullYear());</script>
                All rights reserved | This template is
                made with <i aria-hidden="true" class="fa fa-heart-o"></i> by <a href="https://colorlib.com"
                                                                                 target="_blank">Colorlib</a>
                <!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
            </p>
        </div>
    </div>
</footer>
<!-- End footer Area -->


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/intlTelInput.min.js"></script>


<script src="https://www.paypal.com/sdk/js?client-id=AStk-Dz8UoZmzyyzrI-Jtfyw97DQ5ZFgrRVUxKRwfUfusgBE-7vj4LSjaTF6JPwlU6rI-_zmzJITMTZW&buyer-country=US&currency=USD&components=buttons"></script>


<script th:src="@{/js/vendor/jquery-2.2.4.min.js}"></script>
<script crossorigin="anonymous"
        integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4"
        src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>


<!-- End footer Area -->
<script th:src="@{/js/vendor/bootstrap.min.js}"></script>
<script th:src="@{/js/jquery.ajaxchimp.min.js}"></script>
<script th:src="@{/js/jquery.nice-select.min.js}"></script>
<script th:src="@{/js/jquery.sticky.js}"></script>
<script th:src="@{/js/nouislider.min.js}"></script>
<script th:src="@{/js/jquery.magnific-popup.min.js}"></script>
<script th:src="@{/js/owl.carousel.min.js}"></script>
<script th:src="@{/js/main.js}"></script>

<script>

    var country;
    // =======================================================
    // Function to load the user's saved address using AJAX
    //========================================================
    function loadSavedAddress() {
        $.ajax({
            url: `/customers/address`,  // Replace with the correct backend endpoint
            method: 'GET',
            success: function (address) {
                // Prepare the address HTML
                country = address.country;
                let addressHTML = '';
                if (address && address.name) {
                    addressHTML = `
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <tbody>
                            <tr>
                                <td style="padding: 12px; border: 1px solid #ddd;"><strong>Name:</strong></td>
                                <td style="padding: 12px; border: 1px solid #ddd;">${address.name}</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; border: 1px solid #ddd;"><strong>Address:</strong></td>
                                <td style="padding: 12px; border: 1px solid #ddd;">${address.address}, ${address.city}, ${address.country}</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; border: 1px solid #ddd;"><strong>Phone:</strong></td>
                                <td style="padding: 12px; border: 1px solid #ddd;">${address.phone}</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; border: 1px solid #ddd;"><strong>Email:</strong></td>
                                <td style="padding: 12px; border: 1px solid #ddd;">${address.email}</td>
                            </tr>
                        </tbody>
                    </table>
                `;

                } else {
                    addressHTML = `<p>No saved address found.</p>`;
                }

                // Display address and the Edit button
                document.getElementById('address-section').innerHTML = `
                    <div>
                        ${addressHTML}
                        <button class="primary-btn" id="edit-address-btn">Edit Address</button>
                    </div>
                    <div id="address-form-container" style="display: none;"></div> `;

                // Add event listener for the Edit Address button
                document.getElementById('edit-address-btn').addEventListener('click', function () {
                    const addressFormHTML = `
                    <p>Please enter your address below:</p>
                    <form id="address-form">
                        <div class="form-group">
                            <label for="name">Name:</label>
                            <input type="text" id="name" class="form-control" value="${address ? address.name : ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="street">Street:</label>
                            <input type="text" id="street" class="form-control" value="${address ? address.address : ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="city">City:</label>
                            <input type="text" id="city" class="form-control" value="${address ? address.city : ''}" required>
                        </div>
                        <div class="form-group">
                            <label for="state">State:</label>
                            <input type="text" id="state" class="form-control" value="${address ? address.country : ''}" required>
                        </div>

                        <div class="form-group">
                            <label for="phone">Phone:</label>
                            <input type="text" id="phone" class="form-control" value="${address ? address.phone : ''}" required>
                        </div>

                        <button type="button" class="primary-btn" id="save-address-btn">Save Address</button>
                    </form>
                `;

                    // Show the address form
                    document.getElementById('address-form-container').innerHTML = addressFormHTML;
                    document.getElementById('address-form-container').style.display = 'block';

                    // Add event listener for save address button
                    document.getElementById('save-address-btn').addEventListener('click', function () {
                        const addressData = {
                            name: document.getElementById('name').value,
                            address: document.getElementById('street').value,
                            city: document.getElementById('city').value,
                            country: document.getElementById('state').value,
                            phone: document.getElementById('phone').value,
                            email: document.getElementById('email').value
                        };

                        $.ajax({
                            url: `/customers/address`, // Replace with the correct endpoint
                            method: 'PUT',
                            contentType: 'application/json',
                            data: JSON.stringify(addressData),
                            success: function (response) {
                                showActionMessage('Address saved successfully!', 'success');
                                loadSavedAddress(); // Reload address to reflect changes
                            },
                            error: function (xhr, status, error) {
                                showActionMessage('Failed to save address. Please try again.', 'error')
                                console.log('Error saving address:', status, error);  // Log detailed error
                            }
                        });
                    });
                });
            },
            error: function (xhr, status, error) {
                console.log('Error fetching address:', status, error);  // Log detailed error
            }
        });
    }


    //=============================
    // Load Cart Items
    //==============================
    // save this as global | don't repeat api calls
    let itemsTotalPrice = 0;
    let initialShippingCost = 50;
    let globalCartItems = "";
    let checkoutData;
    let orderId;
    $(document).ready(function () {
        fetchOrderDetails();

        function fetchOrderDetails() {
            $.ajax({
                url: `/cart/checkout`, // Your endpoint to fetch order details
                method: 'GET',
                contentType: 'application/json',
                success: function (items) {
                    globalCartItems = items;
                    // Call a function to populate the order section
                    console.log(items);
                    populateOrderSection(items);
                    populateOrderSummary(items);
                },
                error: function (xhr, status, error) {
                    console.error('Error fetching orders:', error);
                    $('#order-section').html('<p>Error fetching order details. Please try again.</p>');
                }
            });
        }

    });




    // ==============================
    // Render order details section and order summary
    //====================================
    // Function to populate the order details
    function populateOrderSection(items) {
        // Clear the existing content
        $('#order-section').empty();

        if (items.length === 0) {
            $('#order-section').html('<p>No items found in your cart.</p>');
            return;
        }

        // Create table structure for cart items
        var cartItemsTable = `
            <table style="width: 100%; border-collapse: collapse;" id="cart-items-table">
                <thead>
                    <tr style="border-bottom: 2px solid #000;">
                        <th style="text-align: left; padding: 8px;">Product Name</th>
                        <th style="text-align: left; padding: 8px;">Price</th>
                        <th style="text-align: left; padding: 8px;">Quantity</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        `;

        // Append the table to the order section
        $('#order-section').append(cartItemsTable);

        // Populate the table with cart items
        items.forEach(function (item) {
            itemsTotalPrice += item.product.price;
            var cartItemsHtml = `
                <tr style="border-bottom: 1px solid #ccc;">
                    <td style="padding: 8px;">${item.product.name}</td>
                    <td style="padding: 8px;">$${item.product.price.toFixed(2)}</td>
                    <td style="padding: 8px;">${item.quantity}</td>
                </tr>
            `;
            // Append each row to the table's tbody
            $('#cart-items-table tbody').append(cartItemsHtml);
        });
    }

    // Function to populate the order summary
    function populateOrderSummary(cartItems, shippingCost = initialShippingCost) {
        // Clear any existing content
        $('#order-items').empty();
        $('#subtotal').empty();
        $('#shipping-cost').empty();
        $('#total-price').empty();

        // If no cart items, show a message
        if (!cartItems || cartItems.length === 0) {
            $('#order-items').html('<p>No items in your cart.</p>');
            return;
        }

        // Step 1: Render the Cart Items Table
        let subtotal = 0;
        let orderItemsHTML = `
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
            <thead>
                <tr style="background-color: #f2f2f2; text-align: left;">
                    <th style="padding: 12px; border: 1px solid #ddd;">Product Name</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Quantity</th>
                    <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Total</th>
                </tr>
            </thead>
            <tbody>
                ${cartItems.map(item => {
            let itemTotal = item.product.price * item.quantity;
            subtotal += itemTotal;

            return `
                        <tr>
                            <td style="padding: 12px; border: 1px solid #ddd;">${item.product.name}</td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${item.quantity}</td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">$${itemTotal.toFixed(2)}</td>
                        </tr>
                    `;
        }).join('')}
            </tbody>
        </table>
    `;

        // Step 2: Calculate total and populate subtotal, shipping, and total
        itemsTotalPrice = subtotal;
        let totalToShow = itemsTotalPrice + shippingCost;
        let subTotalHTML = `<li><a>Subtotal <span>$${subtotal.toFixed(2)}</span></a></li>`;
        let shippingCostHTML = `<li><a>Shipping <span id="shipping-value">$${shippingCost.toFixed(2)}</span></a></li>`;
        let totalPriceHTML = `<li><a>Total <span id="total-price-value">$${totalToShow.toFixed(2)}</span></a></li>`;

        // Append the generated HTML to the respective sections
        $('#order-items').append(orderItemsHTML);
        $('#subtotal').append(subTotalHTML);
        $('#shipping-cost').append(shippingCostHTML);
        $('#total-price').append(totalPriceHTML);

    }


    //=========================
    // Process payment section
    //=========================
    // Toggle payment method sections based on the selected payment option
    document.querySelectorAll('input[name="payment"]').forEach((input) => {
        input.addEventListener('change', function () {
            if (this.value === 'Card') {
                document.getElementById('saved-cards-section').style.display = 'block';
                document.getElementById('new-card-section').style.display = 'block';
            } else if (this.value === 'COD') {
                document.getElementById('saved-cards-section').style.display = 'none';
                document.getElementById('new-card-section').style.display = 'none';
            }
        });
    });

    // Fetch saved cards from the backend via AJAX
    function loadSavedCards() {
        const savedCardsSection = document.getElementById('saved-cards-section');
        savedCardsSection.innerHTML = '';
        $.ajax({
            url: `/cards`,  // Update with actual backend endpoint
            method: 'GET',
            success: function (cards) {
                //const savedCardsSection = document.getElementById('saved-cards-section');
                if (cards.length > 0) {
                    cards.forEach(card => {
                        const cardHTML = `
                        <div class="card-option" style="border: 1px solid #ddd; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); transition: transform 0.3s ease; cursor: pointer;">
                            <input type="radio" id="card-${card.id}" name="saved-card" value="Card-${card.id}" style="margin-right: 15px;">
                            <label for="card-${card.id}" style="display: block; width: 100%;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                   <div style="display: flex; gap: 10px;">
                                        <span style="font-size: 1.1em; font-weight: bold; color: #007bff;">${card.type}</span>
                                        <span style="color: #555;">ending With ****${card.number.slice(-4)}</span>
                                    </div>
                                    <div style="font-size: 0.9em; color: #888; margin-top: 5px;">
                                        Exp: ${card.expMonth}/${card.expYear}
                                    </div>

                                </div>
                            </label>
                        </div>
                    `;


                        savedCardsSection.insertAdjacentHTML("beforeend", cardHTML);

                    });
                } else {
                    savedCardsSection.innerHTML = '<p>You have no saved cards.</p>';
                }
            },
            error: function () {
                console.log('Failed to load saved cards');
            }
        });
    }


    // ==============================
    // Handle Promotion code
    //====================================
    let finalShippingCost = 50;
    document.getElementById("apply-coupon").addEventListener("click", function () {
        let couponCode = document.getElementById("coupon-code").value;
        const messageDiv = document.getElementById("message");

        messageDiv.textContent = "";

        if (!couponCode) {
            displayMessage("Please enter a coupon code.", "error");
            return;
        }

        console.log("items total price = " + itemsTotalPrice);

        // Validate the coupon
        fetch(`/promotions/validate?promotionName=${encodeURIComponent(couponCode)}&country=${encodeURIComponent(country)}`)
            .then(response => response.json())
            .then(data => {
                if (data) {
                    displayMessage(`Congratulations! Promotion applied with discount ${data.discountPercentage}%`, "success");
                    console.log(data)
                    // Handle shipping cost
                    let shippingCost = data.freeShipping ? 0 : 50;
                    finalShippingCost = shippingCost;
                    if(shippingCost > 0)
                        document.getElementById("shipping-value").textContent = shippingCost.toFixed(2);
                    else
                        document.getElementById("shipping-value").textContent = "Free"
                    console.log(shippingCost)
                    // Calculate discount based on total price including shipping
                    let totalBeforeDiscount = itemsTotalPrice + shippingCost;
                    console.log(totalBeforeDiscount)
                    const discount = (totalBeforeDiscount * data.discountPercentage) / 100; // Calculate discount based on total
                    const finalTotal = totalBeforeDiscount - discount; // Final total after discount
                    itemsTotalPrice = finalTotal;
                    console.log("items final total " + itemsTotalPrice)
                    // Update the total price in the UI
                    document.getElementById("total-price-value").textContent = finalTotal.toFixed(2); // Ensure proper decimal format
                    //document.getElementById("shipping-value").textContent = shippingCost.toFixed(2);
                } else {
                    displayMessage("Invalid promotion code.", "error");
                }
                document.getElementById("coupon-code").value = "";
            })
            .catch(error => {
                displayMessage("This Promo code is Invalid or used before", "error");
                document.getElementById("coupon-code").value = "";
                console.error("Error:", error);
            });


    });


    function displayMessage(message, type) {
        const messageDiv = document.getElementById("message");
        messageDiv.textContent = message;
        messageDiv.style.color = type === "success" ? "green" : "red";
    }

    //==================================================================================================
    // place order handling
    //==================================================================================================
    function makeOrder(paypal) {
        return new Promise((resolve, reject) => {
            const payMethod = paypal ? "Paypal" : $('input[name="payment"]:checked').val();

            // Prepare checkout data
            const checkoutData = {
                shippingAddress: $('#shippingAddress').val(),
                items: globalCartItems,
                paymentMethod: payMethod,
                totalPrice: itemsTotalPrice + finalShippingCost,
                shippingCost: finalShippingCost
            };

            console.log(checkoutData);

            // AJAX call to send the checkout request to the backend
            $.ajax({
                url: '/orders',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(checkoutData),
                success: function (orderDTO) {
                    console.log('Order placed successfully:', orderDTO);
                    const orderId = orderDTO.orderId;

                    // Clear the cart after placing the order
                    $.ajax({
                        url: '/cart/clear',
                        method: 'DELETE',
                        success: function () {
                            console.log('Cart cleared successfully.');
                        },
                        error: function (error) {
                            console.error('Error clearing the cart:', error);
                        },
                        complete: function () {
                            // Redirect to confirmation page
                            window.location.href = `/checkout/confirm?orderId=${orderId}`;
                            resolve(); // Notify success
                        }
                    });

                    sessionStorage.setItem('orderId', orderId);
                },
                error: function (xhr, status, error) {
                    let errorMessage;

                    if (xhr.responseJSON && xhr.responseJSON.details) {
                        errorMessage = xhr.responseJSON.details;
                    } else if (xhr.responseText && !xhr.responseText.startsWith('<')) {
                        errorMessage = xhr.responseText;
                    } else {
                        errorMessage = "An unexpected error occurred: " + error;
                    }

                    console.error(errorMessage);
                    showActionMessage(`Can't place Order: ${errorMessage}`, 'error');
                    reject(new Error(errorMessage)); // Notify failure
                }
            });
        });
    }


    $(document).ready(function () {
        $('#place-order-btn').click(function (event) {
            event.preventDefault();

            const placeOrderBtn = document.getElementById("place-order-btn");
            const spinner = document.getElementById("spinner");
            const buttonText = document.getElementById("button-text");

            // Disable the button and show spinner
            placeOrderBtn.disabled = true;
            buttonText.textContent = "Processing...";
            spinner.style.display = "inline-block";

            makeOrder(false)
                .then(() => {
                    console.log('Order processed successfully.');
                    // The button and spinner state will be reset in the redirection logic
                })
                .catch((error) => {
                    console.error('Error processing order:', error);
                    showActionMessage("Failed to place the order."+error, "error");
                })
                .finally(() => {
                    // Always reset the button and spinner regardless of the outcome
                    placeOrderBtn.disabled = false;
                    buttonText.textContent = "Place Order";
                    spinner.style.display = "none";
                });
        });
    });



    window.paypal
        .Buttons({
            style: {
                shape: "rect",
                layout: "vertical",
                color: "gold",
                label: "paypal",
            },
            message: {
                amount: 100,
            },

            async createOrder() {
                try {
                    const response = await fetch("/api/orders", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        // use the "body" param to optionally pass additional order information
                        // like product ids and quantities
                        body: JSON.stringify({
                            cart: [
                                {
                                    id: "YOUR_PRODUCT_ID",
                                    quantity: "YOUR_PRODUCT_QUANTITY",
                                },
                            ],
                        }),
                    });

                    const orderData = await response.json();

                    if (orderData.id) {
                        return orderData.id;
                    }
                    const errorDetail = orderData?.details?.[0];
                    const errorMessage = errorDetail
                        ? `${errorDetail.issue} ${errorDetail.description} (${orderData.debug_id})`
                        : JSON.stringify(orderData);

                    throw new Error(errorMessage);
                } catch (error) {
                    console.error(error);
                    resultMessage(`Could not initiate PayPal Checkout...<br><br>${error}`);
                }
            },

            async onApprove(data, actions) {
                makeOrder(true);
                return;
                try {
                    const response = await fetch(`/api/orders/${data.orderID}/capture`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                    });

                    const orderData = await response.json();
                    // Three cases to handle:
                    //   (1) Recoverable INSTRUMENT_DECLINED -> call actions.restart()
                    //   (2) Other non-recoverable errors -> Show a failure message
                    //   (3) Successful transaction -> Show confirmation or thank you message

                    const errorDetail = orderData?.details?.[0];

                    if (errorDetail?.issue === "INSTRUMENT_DECLINED") {
                        // (1) Recoverable INSTRUMENT_DECLINED -> call actions.restart()
                        // recoverable state, per
                        // https://developer.paypal.com/docs/checkout/standard/customize/handle-funding-failures/
                        return actions.restart();
                    } else if (errorDetail) {
                        // (2) Other non-recoverable errors -> Show a failure message
                        throw new Error(`${errorDetail.description} (${orderData.debug_id})`);
                    } else if (!orderData.purchase_units) {
                        throw new Error(JSON.stringify(orderData));
                    } else {
                        // (3) Successful transaction -> Show confirmation or thank you message
                        // Or go to another URL:  actions.redirect('thank_you.html');
                        const transaction =
                            orderData?.purchase_units?.[0]?.payments?.captures?.[0] ||
                            orderData?.purchase_units?.[0]?.payments?.authorizations?.[0];
                        resultMessage(
                            `Transaction ${transaction.status}: ${transaction.id}<br>
<br>See console for all available details`
                        );
                        console.log(
                            "Capture result",
                            orderData,
                            JSON.stringify(orderData, null, 2)
                        );
                    }
                } catch (error) {
                    makeOrder(true);
                    console.error(error);
                    resultMessage(
                        `Sorry, your transaction could not be processed...<br><br>${error}`
                    );
                }
            },
        })
        .render("#paypal-button-container");

    // Example function to show a result to the user. Your site's UI library can be used instead.
    function resultMessage(message) {
        const container = document.querySelector("#result-message");
        container.innerHTML = message;
    }


    $(document).ready(function () {
        checkAuthStatus();
        $('#search_input').on('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevents the form submission if search is inside a form
                selectSuggestion($('#search_input').val())
            }
        });
    });

    function checkAuthStatus() {
        $.ajax({
            url: '/auth/status',
            type: 'GET',
            success: function (response) {
                if (response.authenticated) {
                    // User is authenticated
                    $('#dropdown-menu-auth').html(`
                        <li class="nav-item"><a class="nav-link" href="/user/account">My-Account</a></li>
                        <li class="nav-item"><a class="nav-link" href="/logout">Logout</a></li>
                    `);
                } else {
                    // User is not authenticated
                    $('#dropdown-menu-auth').html(`
                        <li class="nav-item"><a class="nav-link" href="/auth/login">Login</a></li>
                        <li class="nav-item"><a class="nav-link" href="/auth/registeration">Register</a></li>
                    `);
                }
            },
            error: function (error) {
                console.error('Error checking authentication status:', error);
            }
        });
    }


    // Function to fetch and display suggestions as user types
    function showSuggestions(query) {
        const suggestionList = $('#suggestions').empty();
        if (query.length < 2) {
            $('#suggestions').hide();
            return;
        }

        $.ajax({
            url: '/products/search',  // Endpoint for suggestions
            type: 'GET',
            data: {name: query},
            success: function (suggestions) {
                console.log(suggestions)
                if (suggestions.length === 0) {
                    suggestionList.hide();
                    return;
                }
                suggestions.forEach(suggestion => {
                    suggestionList.append(`<li onclick="selectSuggestion('${suggestion.name}')">${suggestion.name}</li>`);
                });
                suggestionList.show();
            }
        });
    }
    // Load saved data on page load
    window.onload = function () {
        loadSavedAddress();
        loadSavedCards();
    };

    // Function to set suggestion in search input
    function selectSuggestion(suggestion) {
        console.log(suggestion)
        $('#search_input').val(suggestion);
        $('#suggestions').hide();
        window.location.href = '/shop?param=' + suggestion
        // performSearch()
    }

    function validateCardNumber(cardNumber) {
        // Remove any spaces or dashes from the input
        const sanitizedCardNumber = cardNumber.replace(/\s|-/g, '');

        // Check if the card number is 16 digits and starts with '4'
        const visaCardRegex = /^4\d{15}$/;

        if (visaCardRegex.test(sanitizedCardNumber)) {
            return true;  // Valid Visa card number
        } else {
            return false;  // Invalid Visa card number
        }
    }
    // Real-time validation for card number
    document.getElementById('card-number').addEventListener('input', async function () {
        const cardNumber = this.value;
        const isValid = await validateCardNumber(cardNumber);

        if (isValid) {
            document.getElementById('card-number-error').style.display = 'none';
            document.getElementById('card-number-success').style.display = 'inline';
        } else {
            document.getElementById('card-number-error').style.display = 'inline';
            document.getElementById('card-number-success').style.display = 'none';
        }
    });

    // Real-time validation for expiration month
    document.getElementById('exp-month').addEventListener('input', function () {
        const expMonth = this.value;
        if (isNaN(expMonth) || expMonth < 1 || expMonth > 12) {
            document.getElementById('exp-month-error').style.display = 'inline';
        } else {
            document.getElementById('exp-month-error').style.display = 'none';
        }
    });

    // Real-time validation for expiration year
    document.getElementById('exp-year').addEventListener('input', function () {
        const expYear = this.value;
        const currentYear = new Date().getFullYear();
        if (isNaN(expYear) || expYear < currentYear || expYear > currentYear + 10) {
            document.getElementById('exp-year-error').style.display = 'inline';
        } else {
            document.getElementById('exp-year-error').style.display = 'none';
        }
    });

    // Real-time validation for CVV
    document.getElementById('cvv').addEventListener('input', function () {
        const cvv = this.value;
        const cvvRegex = /^\d{3,4}$/;  // Basic validation for 3-4 digit CVV
        if (!cvvRegex.test(cvv)) {
            document.getElementById('cvv-error').style.display = 'inline';
        } else {
            document.getElementById('cvv-error').style.display = 'none';
        }
    });

    // Handle saving the card with real-time validated inputs
    document.getElementById('save-card-btn').addEventListener('click', function (event) {
        event.preventDefault();

        // If any field shows an error, don't proceed
        function isElementVisible(el) {
            return el.offsetWidth > 0 && el.offsetHeight > 0 && getComputedStyle(el).visibility !== 'hidden';
        }

        const errorMessages = document.querySelectorAll('.error-message');
        const hasVisibleErrors = Array.from(errorMessages).some(isElementVisible);

        if (hasVisibleErrors) {
            console.log('Please fix the errors before saving the card.');
            return;
        }


        // Gather card details (if all inputs are valid)
        const newCardDetails = {
            number: document.getElementById('card-number').value,
            type: "Visa",
            customerName: document.getElementById('card-holder').value,
            expMonth: document.getElementById('exp-month').value,
            expYear: document.getElementById('exp-year').value,
            cvv: document.getElementById('cvv').value,
        };


        // Send AJAX request to save the card
        $.ajax({
            url: `/cards`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(newCardDetails),
            success: function () {
                showActionMessage('Card saved successfully!', 'success')
                loadSavedCards();  // Reload saved cards after saving the new card
            },
            error: function () {
                console.log('Failed to save card. Please try again.');
            }
        });

    });



</script>
</body>

</html>