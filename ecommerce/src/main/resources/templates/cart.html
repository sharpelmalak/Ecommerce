<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" class="no-js">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" th:href="@{/img/icon.png}" />
    <title>Waxen</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- intl-tel-input CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/css/intlTelInput.css"
    />

    <!-- ============================================= -->
    <link rel="stylesheet" th:href="@{/css/linearicons.css}" />
    <link rel="stylesheet" th:href="@{/css/font-awesome.min.css}" />
    <link rel="stylesheet" th:href="@{/css/themify-icons.css}" />
    <link rel="stylesheet" th:href="@{/css/bootstrap.css}" />
    <link rel="stylesheet" th:href="@{/css/owl.carousel.css}" />
    <link rel="stylesheet" th:href="@{/css/nice-select.css}" />
    <link rel="stylesheet" th:href="@{/css/nouislider.min.css}" />
    <link rel="stylesheet" th:href="@{/css/ion.rangeSlider.css}" />
    <link rel="stylesheet" th:href="@{/css/ion.rangeSlider.skinFlat.css}" />
    <link rel="stylesheet" th:href="@{/css/magnific-popup.css}" />
    <link rel="stylesheet" th:href="@{/css/main.css}" />

    <style>
      /* Style for the remove button */
      .remove-btn {
        background-color: #ff4d4d; /* Red background */
        color: white; /* White text */
        border: none; /* No border */
        border-radius: 5px; /* Rounded corners */
        padding: 10px 15px; /* Padding for spacing */
        cursor: pointer; /* Pointer cursor on hover */
        font-size: 14px; /* Font size */
        transition: background-color 0.3s ease; /* Smooth transition */
      }

      /* Hover effect */
      .remove-btn:hover {
        background-color: #ff1a1a; /* Darker red on hover */
      }

      /* Optional: Focus effect */
      .remove-btn:focus {
        outline: none; /* Remove outline */
        box-shadow: 0 0 5px rgba(255, 77, 77, 0.5); /* Glow effect */
      }

      .navbar-brand img {
        max-width: 60%;
        /* Prevents the image from overflowing its container */
        height: auto;
      }

      .navbar-brand {
        max-width: 30%;
        /* Prevents the image from overflowing its container */
        height: auto;
      }

      /* Style for suggestions dropdown */
      #suggestions {
        display: none;
        /* Initially hidden */
        position: absolute;
        top: 100%;
        /* Aligns directly below the input box */
        left: 0;
        width: 100%;
        /* Matches input width */
        background-color: #fff;
        border: 1px solid #ddd;
        border-top: none;
        /* Avoid double border with input */
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        list-style: none;
        padding: 0;
        margin: 0;
        z-index: 1000;
        max-height: 200px;
        /* Limits height */
        overflow-y: auto;
        /* Adds scroll if suggestions exceed max height */
      }

      #suggestions li {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
      }

      #suggestions li:last-child {
        border-bottom: none;
        /* Removes border from last item */
      }

      #suggestions li:hover {
        background-color: #f5f5f5;
      }
    </style>
    <style>
      /* Base style for cart images */
      .media .d-flex img {
        width: 80px; /* Default width for larger screens */
        height: 80px; /* Default height for larger screens */
        object-fit: cover; /* Maintain aspect ratio by cropping */
        border-radius: 5px; /* Optional: add slight rounding */
      }

      /* Medium screens (tablets) */
      @media (max-width: 768px) {
        .media .d-flex img {
          width: 60px; /* Slightly smaller on tablets */
          height: 60px;
        }
      }

      /* Small screens (mobile) */
      @media (max-width: 576px) {
        .media .d-flex img {
          width: 50px; /* Further reduce size on mobile */
          height: 50px;
        }
      }

        /* Small screens (mobile) */
        @media (max-width: 576px) {
            .media .d-flex img {
                width: 50px;         /* Further reduce size on mobile */
                height: 50px;
            }
        }

        .waxen7{
            padding-top: 250px;
        }

        .single-footer-widget p {
            text-align: justify;
        }
    </style>

    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
  </head>

  <body>
    <!-- Start Header Area -->
    <header class="header_area sticky-header">
      <div class="main_menu">
        <nav class="navbar navbar-expand-lg navbar-light main_box">
          <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <a class="navbar-brand logo_h" href="/home"
              ><img src="/img/waxen.jpg" alt=""
            /></a>
            <button
              class="navbar-toggler"
              type="button"
              data-toggle="collapse"
              data-target="#navbarSupportedContent"
              aria-controls="navbarSupportedContent"
              aria-expanded="false"
              aria-label="Toggle navigation"
            >
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <!-- Collect the nav links, forms, and other content for toggling -->
            <div
              class="collapse navbar-collapse offset"
              id="navbarSupportedContent"
            >
              <ul class="nav navbar-nav menu_nav ml-auto">
                <li class="nav-item">
                  <a class="nav-link" href="/home">Home</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="/shop">Shop</a>
                </li>
                <li class="nav-item submenu dropdown">
                  <a
                    href="#"
                    class="nav-link dropdown-toggle"
                    data-toggle="dropdown"
                    role="button"
                    aria-haspopup="true"
                    aria-expanded="false"
                    >Account</a
                  >
                  <ul class="dropdown-menu" id="dropdown-menu-auth"></ul>
                </li>
              </ul>
              <ul class="nav navbar-nav navbar-right">
                <li class="nav-item">
                  <a href="/cart" class="cart"
                    ><span class="ti-shopping-cart"></span
                  ></a>
                </li>
                <li class="nav-item">
                  <button class="search">
                    <span class="lnr lnr-magnifier" id="search"></span>
                  </button>
                </li>
              </ul>
            </div>
          </div>
        </nav>
      </div>
      <div class="search_input" id="search_input_box">
        <div class="container">
          <form class="d-flex justify-content-between" onsubmit="">
            <input
              type="text"
              class="form-control"
              id="search_input"
              placeholder="Search Here"
              oninput="showSuggestions(this.value)"
            />
            <button type="submit" class="btn"></button>
            <span
              class="lnr lnr-cross"
              id="close_search"
              title="Close Search"
            ></span>
          </form>
          <!-- Suggestions List -->
          <ul id="suggestions"></ul>
        </div>
      </div>
    </header>
    <!-- End Header Area -->

    <!-- End Header Area -->
    <div id="action-message" class="action-message" style="display: none;"></div>

    <section class="cart_area waxen7">
      <div class="container">
        <div class="cart_inner">
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th scope="col">Product</th>
                  <th scope="col">Price</th>
                  <th scope="col">Quantity</th>
                  <th scope="col">Total</th>
                  <th scope="col">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  th:each="cartItem : ${cart}"
                  th:data-product-id="${cartItem.product.id}"
                >
                  <td>
                    <div class="media">
                      <div class="d-flex">
                        <img
                          th:src="${cartItem.product.image}"
                          alt="image not loaded"
                        />
                      </div>
                      <div class="media-body">
                        <p th:text="${cartItem.product.name}"></p>
                      </div>
                    </div>
                  </td>
                  <td>
                    <h5 th:text="${cartItem.product.price}"></h5>
                  </td>
                  <td>
                    <div class="product_count">
                      <input
                        type="number"
                        th:id="'qty-' + ${cartItem.product.id}"
                        th:value="${cartItem.quantity}"
                        title="Quantity"
                        class="input-text qty"
                        min="1"
                        onchange=`updateQuantity(${cartItem.product.id},this.value)`
                        disabled
                      />
                      <button
                        th:onclick="'increaseQuantity(' + ${cartItem.product.id} + ')'"
                        class="increase items-count"
                      >
                        <i class="lnr lnr-chevron-up"></i>
                      </button>
                      <button
                        th:onclick="'decreaseQuantity(' + ${cartItem.product.id} + ')'"
                        class="reduced items-count"
                      >
                        <i class="lnr lnr-chevron-down"></i>
                      </button>
                    </div>
                  </td>
                  <td>
                    <h5
                      th:id="'subtotal-'+${cartItem.product.id}"
                      th:text="${cartItem.product.price * cartItem.quantity}"
                    ></h5>
                  </td>
                  <td>
                    <button
                      th:onclick="'removeFromCart(' + ${cartItem.product.id} + ')'"
                      class="remove-btn"
                    >
                      Remove
                    </button>
                  </td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>
                    <h5>Subtotal</h5>
                  </td>
                  <td>
                    <h5 id="cart-total" th:text="${sum}"></h5>
                  </td>
                </tr>
                <tr class="out_button_area">
                  <td></td>
                  <td></td>
                  <td></td>
                  <td>
                    <div class="checkout_btn_inner d-flex align-items-center">
                      <a class="gray_btn" href="/shop">Continue Shopping</a>
                      <a
                        class="primary-btn"
                        href="#"
                        onclick="proceedCheckout()"
                        >Proceed to checkout</a
                      >
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

   <!-- Start footer Area -->
	<footer class="footer-area section_gap">
		<div class="container">
			<div class="row">
				<div class="col-lg-3 col-md-6 col-sm-6">
					<div class="single-footer-widget" style="text-align: justify;">
						<h6 th:text="#{footer.about_us_title}">About Us</h6>
						<p th:text="#{footer.about_us_text}">
							Welcome to Waxen, where luxury and style meet in every timepiece...
						</p>
					</div>
					<a href="?lang=en" th:text="#{footer.language_english}">English</a> |
					<a href="?lang=ar" th:text="#{footer.language_arabic}">العربية</a>
				</div>

				<div class="col-lg-4 col-md-6 col-sm-6">
					<div class="single-footer-widget">
						<h6 th:text="#{footer.newsletter_title}">Newsletter</h6>
						<p th:text="#{footer.newsletter_text}">Stay updated with our latest</p>
						<div id="mc_embed_signup">
							<form target="_blank" novalidate="true"
								action="https://spondonit.us12.list-manage.com/subscribe/post?u=1462626880ade1ac87bd9c93a&amp;id=92a4423d01"
								method="get" class="form-inline">
								<div class="d-flex flex-row">
									<input class="form-control" name="EMAIL"
										th:placeholder="#{footer.newsletter_placeholder}" required="" type="email">
									<button class="click-btn btn btn-default"><i class="fa fa-long-arrow-right"
											aria-hidden="true"></i></button>
								</div>
								<div class="info"></div>
							</form>
						</div>
					</div>
				</div>

				<div class="col-lg-3 col-md-6 col-sm-6">
					<div class="single-footer-widget mail-chimp">
						<h6 th:text="#{footer.instagram_feed}">Instagram Feed</h6>
						<ul class="instafeed d-flex flex-wrap">
							<li><img src="img/i1.jpg" alt=""></li>
							<li><img src="img/i2.jpg" alt=""></li>
							<li><img src="img/i3.jpg" alt=""></li>
							<li><img src="img/i4.jpg" alt=""></li>
							<li><img src="img/i5.jpg" alt=""></li>
							<li><img src="img/i6.jpg" alt=""></li>
							<li><img src="img/i7.jpg" alt=""></li>
							<li><img src="img/i8.jpg" alt=""></li>
						</ul>
					</div>
				</div>

				<div class="col-lg-2 col-md-6 col-sm-6">
					<div class="single-footer-widget">
						<h6 th:text="#{footer.follow_us}">Follow Us</h6>
						<p th:text="#{footer.social_text}">Let us be social</p>
						<div class="footer-social d-flex align-items-center">
							<a href="#"><i class="fa fa-facebook"></i></a>
							<a href="#"><i class="fa fa-twitter"></i></a>
							<a href="#"><i class="fa fa-dribbble"></i></a>
							<a href="#"><i class="fa fa-behance"></i></a>
						</div>
					</div>
				</div>
			</div>
			<div class="footer-bottom d-flex justify-content-center align-items-center flex-wrap">
				<p class="footer-text m-0" th:utext="#{footer.copyright_text}">
					Copyright &copy;
					<script>document.write(new Date().getFullYear());</script>
				</p>
			</div>
		</div>
	</footer>
	<!-- End footer Area -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/intlTelInput.min.js"></script>

    <script th:src="@{/js/vendor/jquery-2.2.4.min.js}"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"
      integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4"
      crossorigin="anonymous"
    ></script>

    <!-- End footer Area -->
    <script th:src="@{/js/vendor/bootstrap.min.js}"></script>
    <script th:src="@{/js/jquery.ajaxchimp.min.js}"></script>
    <script th:src="@{/js/jquery.nice-select.min.js}"></script>
    <script th:src="@{/js/jquery.sticky.js}"></script>
    <script th:src="@{/js/nouislider.min.js}"></script>
    <script th:src="@{/js/jquery.magnific-popup.min.js}"></script>
    <script th:src="@{/js/owl.carousel.min.js}"></script>
    <script th:src="@{/js/main.js}"></script>

    <script>
      function updateQuantity(productId, qty) {
        if (qty < 1) {
          return;
        }
        $.ajax({
          url: "/cart/update", // Ensure this endpoint handles the update logic
          type: "GET",
          contentType: "application/json",
          data: {
            // Send as query parameters instead of JSON
            productId: productId,
            quantity: qty,
          },
          success: function (response) {
            console.log(response);
            // Update the cart item and summary without reloading the page
            if (response.product.quantity >= qty) {
              updateCartItemUI(productId, response);
            } else {
              response.quantity = response.product.quantity;
              updateCartItemUI(productId, response);
              showActionMessage('Exceed Stock','error')
            }
            updateCartSummary();
          },
          error: function () {
            showActionMessage('Failed to update quantity','error')
          },
        });
      }

      function increaseQuantity(productId) {
        const qtyInput = document.getElementById(`qty-${productId}`);
        const newQty = parseInt(qtyInput.value) + 1;
        // qtyInput.value = newQty;
        updateQuantity(productId, newQty);
      }

      function decreaseQuantity(productId) {
        const qtyInput = document.getElementById(`qty-${productId}`);
        const newQty = qtyInput.value - 1;
        //qtyInput.value = newQty;
        updateQuantity(productId, newQty);
      }

      function removeFromCart(productId) {
        $.ajax({
          url: "/cart/remove/" + productId, // Ensure this endpoint handles item removal
          type: "GET",
          success: function (response) {
            // Remove the item from UI and update the summary
            const itemRow = document.querySelector(
              `tr[data-product-id='${productId}']`
            );
            if (itemRow) {
              itemRow.remove(); // Remove the row from the table
            }
            updateCartSummary(); // Update the cart summary if needed
          },
          error: function () {
            showActionMessage('Failed to remove item from cart','error')
          },
        });
      }

      // Utility functions for updating the UI

      function updateCartItemUI(productId, cartItem) {
        // Assuming cartItem contains the updated information including quantity and product price
        const newQuantity = cartItem.quantity; // Get updated quantity
        const newPrice = cartItem.product.price; // Get product price

        // Update the quantity input field
        const qtyInput = document.getElementById(`qty-${productId}`);
        qtyInput.value = newQuantity;

        console.log(productId);
        console.log(`subtotal-${productId}`);
        // Update the subtotal for this specific cart item
        const subtotalElement = document.getElementById(
          `subtotal-${productId}`
        );
        if (subtotalElement) {
          subtotalElement.innerText = (newPrice * newQuantity).toFixed(2); // Calculate and update subtotal
        }
      }

      function updateCartSummary() {
        $.ajax({
          url: "/cart/check",
          type: "GET",
          success: function (response) {
            console.log(response);
            if (response) {
              updateTotal();
            } else {
              showActionMessage('STOCK UPDATES','error')
              window.location.href = "/cart";
            }
          },
          error: function () {
            showActionMessage('STOCK UPDATES','error')
          },
        });
      }

      function updateTotal() {
        const totalElement = document.getElementById("cart-total");
        // Example usage:
        const totalAmount = calculateTotal();
        console.log("Total Amount:", totalAmount);
        if (totalElement) {
          totalElement.textContent = totalAmount;
        }
      }
      function proceedCheckout() {
        // Example usage:
        updateCartSummary();
        const totalAmount = calculateTotal();
        if (totalAmount > 0) {
          window.location.href = "/checkout";
        } else showActionMessage('Your cart is empty','error')
      }
      function calculateTotal() {
        let total = 0;

        // Use a loop to go through each subtotal element
        document
          .querySelectorAll('[id^="subtotal-"]')
          .forEach(function (element) {
            // Parse the subtotal text as a float and add it to the total
            const subtotal = parseFloat(element.innerText) || 0; // Default to 0 if NaN
            total += subtotal;
          });

        return total.toFixed(2); // Return total formatted to two decimal places
      }

      $(document).ready(function () {
        checkAuthStatus();
        updateCartSummary();
        $("#search_input").on("keypress", function (e) {
          if (e.key === "Enter") {
            e.preventDefault(); // Prevents the form submission if search is inside a form
            selectSuggestion($("#search_input").val());
          }
        });
      });

      function checkAuthStatus() {
        $.ajax({
          url: "/auth/status",
          type: "GET",
          success: function (response) {
            if (response.authenticated) {
              // User is authenticated
              $("#dropdown-menu-auth").html(`
                        <li class="nav-item"><a class="nav-link" href="/user/account">My-Account</a></li>
                        <li class="nav-item"><a class="nav-link" href="/logout">Logout</a></li>
                    `);
            } else {
              // User is not authenticated
              $("#dropdown-menu-auth").html(`
                        <li class="nav-item"><a class="nav-link" href="/auth/login">Login</a></li>
                        <li class="nav-item"><a class="nav-link" href="/auth/registeration">Register</a></li>
                    `);
            }
          },
          error: function (error) {
            console.error("Error checking authentication status:", error);
          },
        });
      }

      // Function to fetch and display suggestions as user types
      function showSuggestions(query) {
        const suggestionList = $("#suggestions").empty();
        if (query.length < 2) {
          $("#suggestions").hide();
          return;
        }

        $.ajax({
          url: "/products/search", // Endpoint for suggestions
          type: "GET",
          data: { name: query },
          success: function (suggestions) {
            console.log(suggestions);
            if (suggestions.length === 0) {
              suggestionList.hide();
              return;
            }
            suggestions.forEach((suggestion) => {
              suggestionList.append(
                `<li onclick="selectSuggestion('${suggestion.name}')">${suggestion.name}</li>`
              );
            });
            suggestionList.show();
          },
        });
      }

      // Function to set suggestion in search input
      function selectSuggestion(suggestion) {
        console.log(suggestion);
        $("#search_input").val(suggestion);
        $("#suggestions").hide();
        window.location.href = "/shop?param=" + suggestion;
        // performSearch()
      }
    </script>
  </body>
</html>
